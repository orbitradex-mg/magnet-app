#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ VPS HOSTiQ.ua
# –í–ù–ò–ú–ê–ù–ò–ï: –í—ã–ø–æ–ª–Ω—è–π—Ç–µ —Ç–æ–ª—å–∫–æ –Ω–∞ —á–∏—Å—Ç–æ–º VPS —Å–µ—Ä–≤–µ—Ä–µ
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: bash deploy-hostiq.sh

set -e

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ Magnet App –Ω–∞ HOSTiQ.ua VPS..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ root
if [ "$EUID" -ne 0 ]; then 
    echo "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å –ø—Ä–∞–≤–∞–º–∏ root: sudo bash deploy-hostiq.sh"
    exit 1
fi

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã..."
apt update && apt upgrade -y

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js..."
if ! command -v node &> /dev/null; then
    curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    apt install -y nodejs
fi
echo "‚úÖ Node.js $(node --version) —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PostgreSQL
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PostgreSQL..."
if ! command -v psql &> /dev/null; then
    apt install -y postgresql postgresql-contrib
    systemctl start postgresql
    systemctl enable postgresql
fi
echo "‚úÖ PostgreSQL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

# –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
read -p "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: " DB_PASSWORD
sudo -u postgres psql <<EOF
CREATE USER magnet_user WITH PASSWORD '$DB_PASSWORD';
CREATE DATABASE magnet_db OWNER magnet_user;
GRANT ALL PRIVILEGES ON DATABASE magnet_db TO magnet_user;
\q
EOF
echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2..."
if ! command -v pm2 &> /dev/null; then
    npm install -g pm2
fi
echo "‚úÖ PM2 —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Nginx
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Nginx..."
if ! command -v nginx &> /dev/null; then
    apt install -y nginx
    systemctl start nginx
    systemctl enable nginx
fi
echo "‚úÖ Nginx —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Git
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Git..."
apt install -y git

# –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
read -p "–í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é /var/www/magnet-app): " APP_PATH
APP_PATH=${APP_PATH:-/var/www/magnet-app}

read -p "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –¥–æ–º–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä: example.com): " DOMAIN

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
mkdir -p $APP_PATH
cd $APP_PATH

# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–∏–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤)
read -p "–í–≤–µ–¥–∏—Ç–µ URL Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ Enter, —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å): " GIT_URL
if [ ! -z "$GIT_URL" ]; then
    git clone $GIT_URL .
else
    echo "‚ö†Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω–æ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –≤—Ä—É—á–Ω—É—é –≤ $APP_PATH"
fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
if [ -d "server" ]; then
    echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π backend..."
    cd server
    npm install
    cd ..
fi

if [ -d "client" ]; then
    echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π frontend..."
    cd client
    npm install
    echo "üì¶ –°–±–æ—Ä–∫–∞ frontend..."
    npm run build
    cd ..
fi

# –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞
echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞..."
cat > server/.env <<EOF
DATABASE_URL=postgresql://magnet_user:$DB_PASSWORD@localhost:5432/magnet_db
PORT=5000
NODE_ENV=production
FRONTEND_URL=https://$DOMAIN
EOF

# –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx
echo "üì¶ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx..."
cat > /etc/nginx/sites-available/magnet-app <<EOF
server {
    listen 80;
    server_name $DOMAIN www.$DOMAIN;

    root $APP_PATH/client/build;
    index index.html;

    location / {
        try_files \$uri \$uri/ /index.html;
    }

    location /api {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;
    }
}
EOF

ln -sf /etc/nginx/sites-available/magnet-app /etc/nginx/sites-enabled/
rm -f /etc/nginx/sites-enabled/default
nginx -t
systemctl reload nginx

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –ª–æ–≥–æ–≤
mkdir -p $APP_PATH/logs

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ PM2
echo "üì¶ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
cd $APP_PATH/server
pm2 start index.js --name magnet-app-backend
pm2 save
pm2 startup

echo ""
echo "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ DNS –∑–∞–ø–∏—Å–∏ –¥–ª—è –¥–æ–º–µ–Ω–∞ $DOMAIN –Ω–∞ IP —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞"
echo "2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç: certbot --nginx -d $DOMAIN -d www.$DOMAIN"
echo "3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: pm2 logs magnet-app-backend"
echo "4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å: pm2 status"
echo ""
echo "üîó –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: —Å–º. DEPLOY_HOSTIQ.md"


